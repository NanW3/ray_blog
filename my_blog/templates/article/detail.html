{% extends "base.html" %}
{% load staticfiles %}

{%block title%}
    {{article.title}}
{% endblock title%}
{% block header_extends %}
    <link rel="stylesheet" href="{% static 'article/article_list.css' %}">
    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
{% endblock header_extends %}
{% block article_active %}active{%endblock%}
{% block content%}
<div class="container">
    <div class="row">
        <div class="col-12 col-xs--12 col-xs-offset-1">
            <h3>{{ article.title }}</h3>
            <ul class="article-info-description">
                <li>Author: {{article.author}}</li>
                <li>Created at: {{article.created | date:"m/d/Y G:n:s"}}</li>
                <li>Type: <a href="{% url 'article:articles_with_tag' article.tag.pk%}">{{ article.tag }}</a></li>
                <li>Read({{read}})</li>
            </ul>
            <div class="shadow-sm p-3 mb-2 bg-white rounded">
                <p>{{article.body|safe}}</p>
            </div>
            <hr>
            <ul class="pager">
                {% if previous_article is None %}
                    <li>Prev: No more previous article</li>
                {% else %}
                    <li>Prev: <a href="{% url 'article:article_detail' previous_article.pk%}">{{previous_article.title}}</a></li>
                {% endif %}
                {% if next_article is None %}
                    <li>Next: No more next article</li>
                {% else %}
                    <li>Next: <a href="{% url 'article:article_detail' next_article.pk%}">{{next_article.title}}</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="comment-area">
                <h3 class="comment-area-title">Submit Comment</h3>
                {% if user.is_authenticated %}
                    {{ user.username }} login successfully.
                    Welcome to comment~
                    <form id="comment_form" action="{% url 'update_comment' %}" method="POST" style="overflow:hidden">
                        {% csrf_token %}
                        {% for field in comment_form %}
                            {{field}}
                        {% endfor %}
                        <span id="comment_error" class="text-danger pull-left"></span>
                        <br>
                        <input type="submit" class="btn btn-primary">
                    </form>
                {% else %}
                    Need to login to comment
                    <a class="btn btn-primary" href="{% url 'login' %}?from={{ request.get_full_path }}">Login</a>
                    <span> or </span>
                    <a class="btn btn-danger" href="{% url 'register' %}?from={{ request.get_full_path }}">Register</a>
                {% endif %}
            </div>
            <div class="comment-area">
                <h3 class="comment-area-title">Comment List</h3>
                <div id="comment_list">
                    {% for comment in comments %}
                        <div>
                            {{comment.user.username}}
                            {{comment.comment_time|date:"Y-m-d H:i:s"}}
                            <br>
                            {{comment.text|safe}}
                            <hr>
                        </div>
                    {% empty %}
                        No Comment
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock content %}

{% block script_extends%}
    <script type="text/javascript">
        $("#comment_form").submit(function(){
            // 判断是否为空
            $("#comment_error").text('');
            if(CKEDITOR.instances["id_text"].document.getBody().getText().trim()==''){
                $("#comment_error").text('评论内容不能为空');
                return false;
            }
            // 更新数据到textarea
            CKEDITOR.instances['id_text'].updateElement();
            // 异步提交
            $.ajax({
                url: "{% url 'update_comment' %}",
                type: 'POST',
                data: $(this).serialize(),
                cache: false,
                success: function(data){
                    console.log(data);
                    if(data['status']=="SUCCESS"){
                        // 插入数据
                        var comment_html = '<div>' + data['username'] +
                                           ' (' + data['comment_time'] + ')：' +
                                           data['text'] + '</div>';
                        $("#comment_list").prepend(comment_html);
                        // 清空编辑框的内容
                        CKEDITOR.instances['id_text'].setData('');
                    }else{
                        // 显示错误信息
                        $("#comment_error").text(data['message']);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
            return false;
        });
    </script>
{% endblock %}